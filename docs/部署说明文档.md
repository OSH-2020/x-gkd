# 部署说明文档

1. 下载 mysql，下载链接：https://www.mysql.com/downloads/

2. 从 github pull 下原代码，github 链接：https://github.com/OSH-2020/x-gkd

3. 安装 rust

4. 使用 cargo new client 和 cargo new server 创建两个名为 client 和 server 的 cargo

5. 打开 client 文件夹，修改 Cargo.toml 文件中的 dependencies 为

   ```
   [dependencies]
   reed-solomon-erasure = "4.0"
   lazy_static = "1.4.0"
   ```

   将代码库中 codes/client/src 的文件夹复制到 client 文件夹的 src 处

6. 打开 server 文件夹，修改 Cargo.toml 文件中的 dependencies 为

   ```
   [dependencies]
   mysql = "17.0.0"
   chrono = "0.4"
   rand = "0.6.0"
   ```

   将代码库中 codes/server/src 的文件夹复制到 server 文件夹的 src 处

7. 首先在 client 中的 client.rs 中修改 ini 的路径：

   let setUpFile = String::from("xxxx\\setup.ini");

   把括号中的路径名改成自己的。

8. 创建 setup.ini 文件

   setup.ini 文件的结构为 

   ```
   {服务器 IP} 
   
   {服务器控制链接端口} 
   
   {服务器数据链接端口} 
   
   {客户端 ID} 
   
   {碎片文件夹路径（用于保存服务器分配来的碎片）} 
   
   {临时文件夹路径（用于在上传过程中保存本地文件的碎片，上传完成后将被清空）} 
   
   {需要监控的上传文件夹数量} 
   
   {上传文件夹 1 路径} 
   
   {上传文件夹 1 中的文件在分布式文件系统中的 path} 
   
   {上传文件夹 2 路径} 
   
   {上传文件夹 2 中的文件在分布式文件系统中的 path} 
   
   .........
   ```

   例子：

   127.0.0.1
   6666
   6668
   1

   

​		D:\mine\homework\file\fragment
​		D:\mine\homework\file\tmp
​		1
​		D:\mine\homework\file\file1
​		TIM

​		而后按照 setup.ini 中的文件路径创建文件夹

9. Query.rs 的文件中需要修改自己的 mysql 密码（xxxx处）

   let pool = my::Pool::new("mysql://root:xxxx@localhost:3306/server_test").unwrap();

10. 打开 mysql，创建新的数据库和表单：

    CREATE DATABASE DFS;

    USE DFS;

    CREATE TABLE `DEVICE` (  
    `ID` int NOT NULL AUTO_INCREMENT,  
    `IP` char(20) NOT NULL DEFAULT '',  
    `PORT` int NOT NULL DEFAULT 0,  
    `ISONLINE` boolean NOT NULL,  
    `RS` int NULL DEFAULT 0 ,  
    PRIMARY KEY (`ID`) 
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8; 

    CREATE TABLE `FRAGMENT` (  
    `ID` int NOT NULL,  
    `PATH` char(20) NOT NULL DEFAULT '',  
    PRIMARY KEY (`ID`) 
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8; 

    CREATE TABLE `FILE` (  
    `ID` int NOT NULL AUTO_INCREMENT,  
    `NAME` char(20) NOT NULL DEFAULT '',  
    `PATH` char(60) NOT NULL DEFAULT '',  
    `ATTRIBUTE` char(10) NOT NULL DEFAULT '',  
    `TIME` char(10) NOT NULL DEFAULT '',  
    `NOA` int NOT NULL DEFAULT 1,  
    `ISFOLDER` boolean NOT NULL DEFAULT false,  
    PRIMARY KEY (`id`) 
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8; 

    CREATE TABLE `REQUEST` (  
    `ID` int NOT NULL AUTO_INCREMENT,  
    `TYPE` int NOT NULL DEFAULT 0,  
    `FRAGMENTID` int NOT NULL DEFAULT 0,  
    `DEVICEID` int NOT NULL DEFAULT 0,  
    PRIMARY KEY (`ID`) 
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8; 

    CREATE TABLE `USER` (  
    `ID` int NOT NULL AUTO_INCREMENT,  
    `NAME` char(20) NOT NULL UNIQUE DEFAULT '', 
    `PASSWD` char(20) NOT NULL DEFAULT '',  
    PRIMARY KEY (`ID`) 
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;

    之后就会看到表单创建成功

    mysql> SHOW TABLES;
    +-----------------------+
    | Tables_in_dfs |
    +-----------------------+
    | device                |
    | file                  |
    | fragment              |
    | request               |
    | user                  |
    +-----------------------+
    5 rows in set (0.02 sec)

11. 加一个 id 为1， isonline 为1 的 device。

    INSERT INTO device (id, isonline)
        -> VALUES
        -> (1,1);

    mysql> SELECT * FROM device;
    +----+----+------+----------+------+
    | ID | IP | PORT | ISONLINE | RS   |
    +----+----+------+----------+------+
    |  1 |    |    0 |        1 |    0 |
    +----+----+------+----------+------+
    1 row in set (0.00 sec)

12. 修改 dataConnect 中的 ClientThread 中的 

    ClientThread{

    ​      client_socket: stream,

    ​      sentence: String::new(),

    ​      download_folder_path: PathBuf::from("xxxx/downloadFragment/"),

    ​      upload_folder_path: PathBuf::from("xxxx/uploadFragment/"),

    ​    }

    xxxx改成所需路径