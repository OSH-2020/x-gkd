# 关于17级项目的分析及尝试

​																																												--pqz

* 整体架构

  <img src="C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20200518231810788.png" alt="image-20200518231810788" style="zoom:200%;" />

* 结构：java工程和Web工程关系

  ![image-20200519120729664](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20200519120729664.png)

  * 客户端（运行在客户主机上）

    * 获取本地目录
    * 文件分块
    * 与服务器进行通信和文件传输
    * 相应服务器进行文件删除

  * 服务器（运行在服务器上）

    * 服务端程序

      * 连接：接受、回复、转发服务请求与控制信息、收发数据（Fragment）
      * 管理（主要是对象是MySql）：维护云共享文件索引、维护各个client的状态信息、记录处理当前等待响应的文件请求

    * Mysql数据库:服务器进程与web服务进程组、服务器进程的各个线程之间均通过Mysql数据库交换数据  
  
* web服务程序（网页后端）
  
  * Apache+Tomcat服务器：前端的Java发出的请求有Apache转发给Tomcat处理
    
  * Structs2 Web应用框架（本质上就是Servlet–>Java编写的服务端程序）作为Browser（也可以理解成一种客户端）和Mysql之间的中间层，主要功能如下
    
    * 读取Browser发送的显式数据和隐士HTTP请求数据
        * 处理数据，生成结果（可能需要和Mysql进行交互）
        * 发送显式的数据和隐式的HTTP响应给Browser
    
    ![image-20200519115524472](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20200519115524472.png)
  
* 网页前端（通过浏览器呈现）
  
  * 使用JavaScript编程实现背后的逻辑，用户点击网页后产生一系列反应（包含JQuery库）
    * 使用Bootstrap可视化前端框架，支持多种浏览器
    * 网页与服务器交互采用AJAX（Asynchronous JS+XML）,是一种与服务器交换的数据的技术，对网页进行部分更新
    * JSON字符串作为前后端通信的格式，可以看作一种独立的语言
  
* 动态网页设计：主要是网页对文件系统的支持，和本地文件进行交互
  
* 客户端
  
  * ![image-20200612151849796](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20200612151849796.png)
  
* 复现遇到的问题：（由于是在Windows系统下复现，故过程和部署范例和教程给的过程有很大区别）

  * jar包以及数据库版本不一致问题  已解决

  * idea与eclipse工程结构不同 已解决

  * 需要下载：Tomcat、JVM、Mysql、需要的jar包（大部分已经在项目中给出） 已解决

  * **工程结构及运行顺序** 已解决

  * **Mysql数据库的了解，如何添加数据库的table** 已解决

  * 在网页上无法注册和登录，可能的原因是**数据库的问题**（服务端和数据库的连接）或者客户端未运行起来

    * 已解决，问题主要是服务端和数据库的连接出现了问题，通过重新配置数据库得到解决
    * 这里的重新配置主要是通过msi镜像来安装，而非按照原来的zip包进行安装。

  * 在客户端的运行方面，自己更改了代码中路径的表示（Linux和Windows下的路径表示不同），但仍无法运行，错误如下

    * `can not register folder`错误出现在FileUploader的createConnection部分

      ![image-20200523225803505](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20200523225803505.png)

    * createConnection部分错误已解决，主要是服务端的DFS_server未运行起来，在配置运行的时候需要将此部分单独添加

    * 最终错误定位到服务端的dataconnect-clientThread模块，无法在数据库中进行相应的操作：已解决

      * 需要在工程中添加mysql-connector-java依赖，并在DB_URL中加入serverTimezone部分（不知道是不是之前省略了，但不加就是不行）
    
  * `can detect files`报错出现在Client和Synltem部分，后续需要继续研究，后来发现只要前面的问题解决这个问题会自动得到解决

    ![image-20200523225929449](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20200523225929449.png)

  * 在数据库的createStatement部分有些需要加上参数，原因是Mysql版本以及不同系统的问题

  * web工程中路径也需要作相应的修改

  * 一个已知的问题是数据库中的device部分需要自行添加ID以及ISONLINE字段，可以后续考虑在程序中自动创建

  ## 一些说明

* **FileUploader 类**：用于发起到服务器的**数据链接**并**上传文件**

* **FolderScanner** 类由启动模块调用执行，在执行的一开始，其将调用FileUploader 类发送检查并新建文件夹报文确保各被监控文件夹对应的逻辑位置存在。之后，其将每隔1 分钟确认一次是否有文件夹中被放入了新文件。如有，其首先获取这个文件的所有属性，然后调用FileUploader 类向服务器注册这个文件。如注册成功，其将调用文件分块模块将文件分块并再次调用FileUploader 类向服务器上传各个文件碎片。
  **FileUploader** 类用来发起到服务器的数据链接发送上传文件相关的报文。其先建立到服务器的TCP 链接，然后根据调用函数的不同发送不同的报文并根据服务器的回复返回不同的值表示状态。

* **报文：**

  * 控制链接

    * **（一）客户端状态报文**
      此报文为客户端的心跳报文，每隔5 秒发送一次，格式为：
      客户端发送：1 {设备ID} {客户端剩余空间}
      服务器回复:received with {等待客户端处理的请求数量} unread request!
      **（二）处理请求报文**
      此报文当客户端发现自己有未处理的请求时发送，服务器将回复等待其处理的请求的具体
      内容。其格式为：
      客户端发送：3 {设备ID}
      服务器回复:{请求ID} {碎片ID} {请求类型}
      **（三）中断连接报文**
      此报文用来在发生异常时立即中断连接，格式为
      客户端或服务器发送：exit

  * 数据链接

    * **（一）客户机碎片上传报文**
      客户端发送:1 {请求ID} {碎片ID}
      服务器回复:received!

      客户端回复：{碎片内容}
      服务器回复: received!
      ----链接中断----
      **（二）客户机碎片下载报文**
      此报文用来从服务器下载其指定的碎片，格式为
      客户端发送: 2 {请求ID} {碎片ID}
      服务器回复: {碎片内容}
      客户端回复: received!
      ----链接中断----

      **（三）客户机碎片删除报文**
      此报文用来通知服务器客户端已经删除了其指定的碎片，格式为
      客户端发送: 3 {请求ID} {碎片ID}
      服务器回复: received!
      ----链接中断----
      **（四）上传文件报文**
      此报文用来申请向分布式文件系统中上传文件，格式为
      客户端发送：4 {设备ID} {文件名} {路径} {属性} {碎片数量} {是不是文件夹}
      服务器回复：FileId: {文件ID}
      ----链接中断----
      **（五）文件碎片上传报文**
      在客户机发送了上传文件报文并收到了服务器回复的文件ID 后，需要使用此报文上传该文
      件的全部碎片。此报文的格式为

      (最后一个碎片一定要最后上传,这时服务器有可能回复UPLOADFAIL 表示整个文件上传失
      败)
      客户端发送:5 {文件ID} {碎片序号} {碎片总数}
      服务器回复: received!
      客户端回复: {碎片内容}
      服务器回复: received!
      ----链接中断----
      **（六）检查并新建文件夹报文**
      当客户端启动时，其需要使用此报文保证被监控的文件夹对应的逻辑位置在服务器上有记
      录。当服务器收到此报文后，如发现该逻辑位置在服务器上没有记录，先新建一条对应的
      记录。
      客户端发送: 6 {设备ID} {文件夹数量}
      {文件夹路径} {文件夹名称} （每行一个文件夹信息）
      服务器回复: received!（如已有/能建立这些文件夹）或ERROR!（如某个文件夹与一个文件重名）
      ----链接中断----

* 

  * rust-webassembly 、WebAssembly-pack、WebAssembly-Bindgen

## Mysql数据库

* 数据库：按照数据结构来组织、存储和管理数据的仓库，一个长期存储在计算机内的、有组织的、可共享的、统一管理的大量数据的集合
* 关系型数据库，存储的格式可以直观地反映实体间的关系。关系型数据库和常见的表格比较相似，关系型数据库中表与表之间是有很多复杂的关联关系的

* Mysql是一种关系型数据库管理系统，关系数据库将数据保存在不同的表中，而不是将所有数据放在一个大仓库内，这样就增加了速度并提高了灵活性。
* 遵循SQL（结构化查询语言，Structured Query Language）标准

* 常用操作

  ![image-20200519005341233](C:\Users\dell\AppData\Roaming\Typora\typora-user-images\image-20200519005341233.png)

  

* 注意用管理员模式对Mysql进行操作，否则权限不够

