# 对调研报告中Rust部分的完善

​																			——孙一鸣

## 项目背景

### Rust

#### 特点

- Rust 的设计目标之一就是优化设计大型的互联网客户端和服务器的任务，因此更加强调安全性、存储器配置、以及并发处理等方面的特性。Rust 强调四个关键词，即系统编程、安全、并发、高效。

- 安全性

  Rust 语言的设计理念是，凡是能够引发程序内存出错的操作，都是不安全的，均不能通过编译。

  Rust 有植入类型系统的生命周期体系，引入了所有权，不允许空指针、悬垂指针、double free、数据竞争等，在编译阶段保证内存安全和线程安全(零开销安全性特点)。

  - 数据竞争问题

    数据竞争（data race）可由这三个行为造成：两个或更多指针同时访问同一数据；至少有一个指针被用来写入数据；没有同步数据访问的机制。

    对于同一作用域内的同一变量，该变量的引用必须满足下述规则之一：默认引用均为不可变引用，不允许修改值；特定作用域中的特定设计最多只有一个可变引用；不能在拥有不可变引用的同时拥有可变引用。

    Rust 通过这样的限制，使可能出现数据竞争的代码不能通过编译。

  - 悬垂指针

    悬垂指针（dangling pointer）是指其指向的内存可能已经被分配给其它持有者的指针，而 Rust 编译器确保数据不会在其被引用之前离开作用域。

  - 引入添加语法来管理生命周期，而且编译器通过租借检查器来说明相关理由。

  程序员可以先使用 unsafe 标签使代码通过编译，再集中调试该代码块。但 unsafe 也仅仅向程序员开放了四种权限：对原始指针进行解引（Dereference raw pointers）；调用 unsafe 函数（包括 C 函数，内部函数，和原始分配器）；实现 unsafe traits；修改（全局）静态变量。

- 高效性能

  性能和标准的 C++ 性能不相上下。

  没有运行时（Run time）和垃圾回收（Garbage Collector），通过生命周期和所有权特性实现内存自动回收，保证了实时性，低开销，适于在嵌入式设备资源匮乏环境下运行。

- 开发环境

  生态逐渐完善。相关工具开发完善中。

  对wasm有较完善的支持。

  - 有依赖管理工具cargo，可以跨平台编译。
  - 安全问题编译器会代替大量在这块的人肉code review。
  - clippy规定了代码格式，代替了人肉code review。
  - 单元测试语言本身就支持而不用引入测试框架。

- 通用性

  不同的编程语言有不同的优点和劣势，程序员希望可以面向不同的需求使用不同的语言。

  Rust 语言是支持外部程序接口调用的，它可以与 C/C++，GO，PHP，Python 混合编程，互相调用。也有各语言的代码转换工具。而 Rust 的无垃圾收集器和较低的运行时需求，都使 Rust 成为被嵌入到其他语言中的一个很好的方案。

- 并发性

  有 std::thread 标准库。

  “安全共享可变状态”：
  
  不允许线程修改外部的可变数据；
  
  只有实现 Send 接口的数据，才能够在线程间转移所有权；
  
  Sync 向编译器指示这个类型在多线程并发时没有导致内存不安全的可能性；
  
  使用“通道”同步多个线程，channel 是线程隔离的，无需担心竞争。
  
  可以使用 lock 保护正在被一个线程使用的数据，确保状态不会意外的被分享。



## 立项依据

### Rust

#### rust相比于其他语言的优势，为何要改写

来源——https://blog.csdn.net/csdnnews/article/details/86570676

《 和 C++ 相比，我为什么要选择 Rust 来开发软件？》

- 低功耗：Rust 是少数非常适合在非常低功耗的嵌入式系统的极其受限的资源上运行的语言之一。

- web方面应用：Rust 其中有些应用程序提供的功能是使用 JavaScript无法实现的。Rust 可以编译成 WebAssembly，它以接近原生的速度在每个主要的 Web 浏览器中运行。有一些工具允许通过 WebAssembly 将 Rust 代码发送到 npm（JavaScript 包存储库），然后透明地向下游用户发送，还可以通过绑定将 Rust 部署到 Web 上，这允许调用浏览器和 JavaScript 本身提供的大多数功能。

- 分布式在线服务：对于网络服务， Rust 可以使用最少资源来确保跨多个线程的内存安全，同时 Rust 还使得编写泄漏内存或其他资源的代码变得更加困难，这些方面可以降低服务器成本并降低运营负担。

- 和 C 和 C++ 相比：

  因为 C 和 C++ 允许空指针引用、释放内存后再使用、返回悬空指针、超出访问权限，是不安全的，将需要花费大量的时间在避免内存问题或者数据竞争问题上，但 Rust 是内存安全的，采取了资源获取即初始化的方法，不必担心内存泄漏和野指针的问题。线程安全的，所以也没有任何数据竞争问题，所有的安全都是由编译器保证的，在大多情况下，编译一旦通过，程序就能安全地运行。

  C++ 没有官方包管理器，这让维护和编译第三方依赖变得异常麻烦和困难，进而导致很长的研发周期。Rust 拥有官方的包管理器 crate ，可以直接使用很多开源的库。

  而且通过 FFI 调用 C 程序是非常快的，不用担心调用 RocksDB API 会有性能上的降低。

- 和 Go 相比：

  Go 的 GC 能修复很多内存问题，但是有时仍然会停止运行中的进程；同时即使我们在测试或运行时使用两次data -race 进行检测，它也没有解决数据竞争问题。Rust 没有 GC 开销，所以不会遇到 “stop the world” 问题。

#### 用 Rust 开发 webassembly 的优势

- 在开发 WebAssembly 时，相比于 AssemblyScript、C++、JavaScript，使用 Rust 开发在开发效率和便捷性、包体积大小等方面有很大优势。
- 用 rust 开发 webassembly 的官方周边文档已经比较全面。
- rust + webassembly 的能力：
  - 可以使用 Rust std，可以使用 Rust 的大多数第三方库。
  - 可以调用几乎任何 JS 侧声明的方法，也可以暴露方法给 JS 调用。
  - 可以和 JS 侧互相”传递“几乎任何的数据类型，包括但不限于数字、字符串、对象、Dom对象等。
  - 可以直接在 Rust 侧“操作”Dom。
- 很多语言（C、C ++ 和 Rust）都可以在 Web 上共享内存线程，但只有 Rust 可以安全地执行该操作。



## 重要性/前瞻性分析

### Rust

#### 发展趋势及学习需求

- Rust 在拥有可以媲美 C 和 C++ 的性能的同时，也拥有极高的安全性和高度控制性，可以避免因为使用 C 和 C++ 而造成的很多漏洞。未来也许有望取代 C/ C++。

- Rust 语言本身有一条开发规范，如结构体、trait 等要求首字母大写、驼峰命名，函数要求蛇形命名法等，因此非常利于项目组统一风格。

- Rust 具有令人信服的高效性，据统计，有超过 40% 的 Rust 用户在不到一个月的使用内即感受到 Rust 语言的高效性，并且连续4年，在Stack Overflow开发者「最受喜爱编程语言」评选中获得第一名。

- 使用 Rust 语言的项目的规模和数目都在不断增大，近来，越来越多的著名项目已经选择使用 Rust 作为其开发语言，包括：Parity、Polkadot等众多知名度较高的项目。

- 支持 Rust 的平台逐渐多样化，如 Windows， Linux 和 Android 等很多大平台都可以支持 Rust 运行。

- 越来越多的公司开始对 Rust 语言表现出浓厚的兴趣，如 Google、Facebook、Twitter 等公司和国内的百度、阿里都开始使用 Rust 来编写或维护项目，但能够熟练使用 Rust 的程序员仍是少数，未来市场将对 Rust 程序员表现出更大的需求量。

#### 存在的问题

- Rust 学习曲线比较陡峭，是比较难掌握的一门语言。
- 编译时间较长。
- 相应的库和工具仍然比较缺乏。
- 需要更优秀的 IDE。

#### 改写的可行性

- Rust 周边文档对于新手较为友好，官方说明文档十分详实，我们都拥有 C 和 C++ 语言的编程经历，可以在一两周内初步上手，采取 ”小步快跑“ 的学习模式，将项目分块进行改写，在语言学习方面可行。
- 基于互联网的小型分布式文件系统是一个轻量级的文件系统，由 Java 编程，代码量约有千余行，用 Rust 改写其中一部分或者全部的工作量是可以接受的。
- Rust 的通用性决定了程序员可以在 Rust 程序中调用 Java 模块，这使得我们可以仅仅改写项目中的一部分重要的代码，其他部分可以调用原有代码。



## 相关工作

### Rust

**相关工作，成功案例**

来源———http://blog.csdn.net/liigo/article/details/45757123

 为什么我说Rust是靠谱的编程语言 Liigo（庄晓立）

- Servo: 

  Servo是高性能、并行浏览器引擎。适用于浏览器应用和嵌入式应用，是下一代浏览器渲染引擎（类Webkit/Blink），拥有超过25万行 Rust 代码量。

  Servo跟Rust并行开发。其里程碑的意义是，它实践并印证了Rust语言具有实际的大中型项目开发能力。

  Servo采用Rust编程语言编写，使浏览器内部有高性能和内存安全性，大幅减少影响浏览器引擎的关键错误数量。采用模块化架构，目前可运行在Linux、macOS、Windows和Android操作系统上。

- rustc+std: Rust编译器和标准库，超过30万行Rust代码。

  时至今日，rustc负责编译全世界所有的Rust源代码，包括rustc+std的30万行和servo的25万行，以及crates.io网站上的2000多个第三方库，是名副其实的大型成功项目。

- Cargo: Rust的package管理器，项目依赖管理。

  代码量相比前两者而言要小的多，代码虽少，但实用性、流行度有过之而无不及。全世界大约99%的Rust项目采用Cargo编译。crates.io网站上有2000多个包，总下载量超150万次。Cargo最大幅度地简化了Rust项目的编译和依赖管理，可以说是目前开发Rust项目的必备工具。

- TiKV

  TiKV 是一个分布式的 Key-Value 数据库。其特点有：异地复制 ；水平扩展 ；一致性分布式事务；分布式计算的协处理器 。

  其需求的语言应拥有如下优点：快速；内存安全；线程安全；和 C 高效绑定。所以选择了 Rust。

##### 参考网站

- https://baijiahao.baidu.com/s?id=1622998388358453257&wfr=spider&for=pc
- https://www.techrepublic.com/article/rust-programming-language-seven-reasons-why-you-should-learn-it-in-2019/
- https://www.rust-lang.org/
- https://www.zhihu.com/question/362330696/answer/947113477
- https://www.zhihu.com/question/30407715/answer/48032883
- https://wiki.jikexueyuan.com/project/rust/concurrency.html
- https://www.jianshu.com/p/e963d92c5697
- https://rust.cc/article?id=37bfd307-b273-4147-9548-0edd670a8b7d

##### 往年用到Rust的项目

- https://github.com/OSH-2019/x-rust-freertos/blob/master/docs/feasibility.md
- https://github.com/OSH-2019/x-i-m-feeling-lucky/blob/master/docs/feasibility.md#3-rust-programming-language

调研、可行性报告中关于rust的部分：与项目关联点，关于rust特有语法的理解和解释